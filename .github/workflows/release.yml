name: Release new version of macOS app

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-latest

    env:
      SCHEME: ${{ vars.SCHEME }}
      APP_NAME: ${{ vars.APP_NAME }}
      BUNDLE_ID: ${{ vars.BUNDLE_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app

      - name: Verify Xcode and Swift versions
        run: |
          xcodebuild -version
          swift --version

      - name: Import Developer ID certificate
        env:
          CERT_P12: ${{ secrets.DEVELOPER_ID_CERT_P12 }}
          CERT_PASSWORD: ${{ secrets.DEVELOPER_ID_CERT_PASSWORD }}
        run: |
          echo "$CERT_P12" | base64 --decode > cert.p12
          security create-keychain -p "" build.keychain
          security import cert.p12 \
            -k build.keychain \
            -P "$CERT_PASSWORD" \
            -T /usr/bin/codesign
          security list-keychains -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-keychain-settings
          security set-key-partition-list \
            -S apple-tool:,apple:,codesign: \
            -s \
            -k "" build.keychain

      - name: Clean build directory
        run: |
          rm -rf build
          mkdir -p build

      - name: Build archive
        run: |
          xcodebuild archive \
            -scheme "$SCHEME" \
            -configuration Release \
            -archivePath build/$SCHEME.xcarchive

      - name: Export signed app
        run: |
          xcodebuild -exportArchive \
            -archivePath build/$SCHEME.xcarchive \
            -exportPath build/export \
            -exportOptionsPlist ExportOptions.plist

      - name: Verify codesign
        run: |
          codesign --verify --deep --strict build/export/$APP_NAME.app

      - name: Staple or notarize
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        run: |
          set -euo pipefail

          echo "Attempting to staple..."
          if xcrun stapler staple "build/export/$APP_NAME.app"; then
            echo "Already notarized."
          else
            echo "Not notarized yet."

            echo "Creating temporary zip..."
            cd build/export
            zip -r "$APP_NAME.notarize.zip" "$APP_NAME.app"

            echo "Submitting for notarization (with 15-min timeout)..."
            xcrun notarytool submit \
              "$APP_NAME.notarize.zip" \
              --apple-id "$APPLE_ID" \
              --team-id "$APPLE_TEAM_ID" \
              --password "$APPLE_APP_SPECIFIC_PASSWORD" \
              --wait \
              --timeout 15m || {
                echo "Notarization still pending after 15 min. Re-run workflow."
                exit 1
              }

            xcrun stapler staple "$APP_NAME.app"
          fi

          xcrun stapler validate "$APP_NAME.app"

      - name: Create distributable zip (with stapled app)
        run: |
          cd build/export
          zip -r "$APP_NAME.zip" "$APP_NAME.app"

      - name: Perform Gatekeeper check
        run: |
          spctl --assess --type execute "build/export/$APP_NAME.app"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: build/export/${{ env.APP_NAME }}.zip
          generate_release_notes: true
