name: Release new version of macOS app

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    runs-on: macos-latest

    env:
      SCHEME: ${{ vars.SCHEME }}
      APP_NAME: ${{ vars.APP_NAME }}
      BUNDLE_ID: ${{ vars.BUNDLE_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app

      - name: Import Developer ID certificate
        env:
          CERT_P12: ${{ secrets.DEVELOPER_ID_CERT_P12 }}
          CERT_PASSWORD: ${{ secrets.DEVELOPER_ID_CERT_PASSWORD }}
        run: |
          echo "$CERT_P12" | base64 --decode > cert.p12
          security create-keychain -p "" build.keychain
          security import cert.p12 -k build.keychain -P "$CERT_PASSWORD" -T /usr/bin/codesign
          security list-keychains -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-keychain-settings

      - name: Clean build directory
        run: |
          rm -rf build
          mkdir -p build

      - name: Build archive
        run: |
          xcodebuild archive \
            -scheme "$SCHEME" \
            -configuration Release \
            -archivePath build/$SCHEME.xcarchive

      - name: Export signed app
        run: |
          xcodebuild -exportArchive \
            -archivePath build/$SCHEME.xcarchive \
            -exportPath build/export \
            -exportOptionsPlist ExportOptions.plist

      - name: Verify codesign
        run: |
          codesign --verify --deep --strict build/export/$APP_NAME.app

      - name: Create notarization zip
        run: |
          cd build/export
          zip -r "$APP_NAME.notarize.zip" "$APP_NAME.app"

      - name: Notarize
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        run: |
          xcrun notarytool submit \
            "build/export/$APP_NAME.notarize.zip" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD" \
            --wait

      - name: Staple app
        run: |
          xcrun stapler staple "build/export/$APP_NAME.app"
          xcrun stapler validate "build/export/$APP_NAME.app"

      - name: Create distributable zip (stapled app)
        run: |
          cd build/export
          zip -r "$APP_NAME.zip" "$APP_NAME.app"

      - name: Gatekeeper check
        run: |
          spctl --assess --type execute "build/export/$APP_NAME.app"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: build/export/${{ env.APP_NAME }}.zip
          generate_release_notes: true
